<UserControl x:Class="NV.CT.Service.AutoCali.UI.AutoCaliTaskUC"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="clr-namespace:NV.CT.Service.Common.Controls.Views;assembly=NV.CT.Service.Common.Controls"
             xmlns:views="clr-namespace:NV.CT.Service.AutoCali.UI"
             xmlns:framework="clr-namespace:NV.CT.Service.Common.Framework;assembly=NV.CT.Service.Common"
             xmlns:calc="clr-namespace:CalcBinding;assembly=CalcBinding"
             xmlns:logic="clr-namespace:NV.CT.Service.AutoCali.UI.Logic"
             xmlns:res="clr-namespace:NV.CT.Service.Common.Resources;assembly=NV.CT.Service.Common"
             mc:Ignorable="d" DataContextChanged="UserControl_DataContextChanged"
             HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Loaded="Root_Loaded" Unloaded="Root_Unloaded"
             x:Name="Root"
             d:DesignHeight="968" d:DesignWidth="1024">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../../Resources/CommonResources.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <ControlTemplate TargetType="{x:Type GroupItem}" x:Key="templateOfGroupItem">
                <Expander Grid.Column="2" x:Name="expander" IsExpanded="True" DataContext="{Binding Name}" >
                    <Expander.Header>
                        <Grid x:Name="PART_Grid_GroupItem">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto "/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <views:ProcessStatusControl Grid.Column="0"/>
                            <CheckBox Grid.Column="1" VerticalContentAlignment="Center" IsChecked="{Binding IsChecked}" Padding="5,0"
                                      IsEnabled="{calc:Binding '!(CaliTaskState == logic:CaliTaskState.WaitingToRun || CaliTaskState == logic:CaliTaskState.Running)'}"/>
                            <TextBlock Grid.Column="2" FontWeight="Bold" Text="{Binding Name}"/>
                        </Grid>
                    </Expander.Header>
                    <Expander.Content>
                        <ItemsPresenter />
                    </Expander.Content>
                </Expander>
            </ControlTemplate>

            <ControlTemplate TargetType="{x:Type GroupItem}" x:Key="templateOfGroupItem_DebugMode">
                <Expander Grid.Column="2" x:Name="expander" IsExpanded="True">
                    <Expander.Header>
                        <Grid x:Name="PART_Grid_GroupItem">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto "/>
                                <RowDefinition Height="auto "/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <views:ProcessStatusControl Grid.Column="0" DataContext="{Binding Path=Name}"/>
                            <CheckBox Grid.Column="1" IsChecked="{Binding Path=Name.IsChecked}" VerticalContentAlignment="Center"
                                      IsEnabled="{calc:Binding '!(CaliTaskState == logic:CaliTaskState.WaitingToRun || CaliTaskState == logic:CaliTaskState.Running)'}"/>

                            <DockPanel Grid.Column="2" HorizontalAlignment="Left">
                                <TextBlock FontWeight="Bold" Text="{Binding Path=Name.Name}" Margin="5,0,0,0" Width="500"/>
                            </DockPanel>

                            <Grid x:Name="PART_T03_RawData_RootPath" Grid.Row="1" Grid.ColumnSpan="3" Width="700" HorizontalAlignment="Left">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="auto" MinWidth="40"/>
                                    <ColumnDefinition Width="auto" MinWidth="40"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" Text="单帧生数据的【上级】文件夹"
                                           ToolTip="单帧生数据（T03格式）的【上级】文件夹，&#13;比如D:\RawData-T03\Offset，&#13;
                                           包括子目录D:\RawData-T03\Offset\DarkH,&#13;包括子目录D:\RawData-T03\Offset\DarkL"/>
                                <TextBox Grid.Column="1" Name="T03_RawDataPathTextBox" HorizontalAlignment="Stretch"
                                         ToolTip="单帧生数据（T03格式）的【上级】文件夹，&#13;比如D:\RawData-T03\Offset，&#13;
                                         包括子目录D:\RawData-T03\Offset\DarkH,&#13;包括子目录D:\RawData-T03\Offset\DarkL"
                                         Text="{Binding T03_RawDataPath,Mode=TwoWay,UpdateSourceTrigger=LostFocus}"/>

                                <Button Grid.Column="2" Name="selectT03_RawData_RootPathButton"
                                        Content="..." ToolTip="Select RawData_RootPath of T03" Width="auto"
                                        Click="selectT03_RawData_RootPathButton_Click"/>
                                <Button Grid.Column="3" Content="Convert" ToolTip="Auto convert All RawData T03 -> S03" Width="auto" Margin="10,0"
                                        Click="ConvertRawData_RootPathButton_Click"/>
                            </Grid>

                        </Grid>
                    </Expander.Header>
                    <Expander.Content>
                        <ItemsPresenter />
                    </Expander.Content>
                </Expander>
            </ControlTemplate>

        </ResourceDictionary>
    </UserControl.Resources>

    <!--ToDo:暂时添加AdornerDecorator作为View的父节点，避免MCS的皮肤库解析错误“VisualParents Must have AdornerDecorator!”-->
    <AdornerDecorator>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="1*"/>
                <RowDefinition Height="auto"/>

                <RowDefinition Height="1*" x:Name="imageRow"/>
                <!--<RowDefinition Height="auto"/>
                <RowDefinition Height="auto"/>-->
            </Grid.RowDefinitions>

            <!--子项：校准项目，协议-->
            <!--<ScrollViewer VerticalScrollBarVisibility="Visible">-->
            <Grid Grid.Row="0" VerticalAlignment="Stretch" DataContext="{Binding SelectedCaliItemTaskViewModel}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="25"/>
                </Grid.RowDefinitions>

                <GroupBox Margin="5" x:Name="protocolContainer"
                          DataContextChanged="protocolContainer_DataContextChanged">
                    <GroupBox.Header>
                        <Grid>

                            <Grid.Resources>
                                <Style TargetType="{x:Type CheckBox}" BasedOn="{StaticResource {x:Type CheckBox}}">
                                    <Setter Property="Margin" Value="5,0"/>
                                    <Setter Property="MinWidth" Value="120"/>
                                </Style>
                            </Grid.Resources>

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Text="{x:Static res:Calibration_Lang.Calibration_Protocol}"/>

                            <WrapPanel x:Name="debugModeContainer" Grid.Column="1" Orientation="Horizontal" Visibility="Visible">
                                <CheckBox x:Name="switchDebugModeCheckBox" Content="DebugMode"
                                          ToolTip="启用调试模式，可以跳过扫描，手动指定扫描的生数据目录"
                                          Click="SwitchDebugModeCheckBox_Click"/>

                                <CheckBox x:Name="checkAllCheckBox" Content="All" IsChecked="{Binding IsCheckedAllSub}"
                                          Click="OnFilter" CommandParameter="all"/>
                                <CheckBox x:Name="kV120CheckBox" Content="kV:120" IsChecked="False"
                                          Click="OnFilter" CommandParameter="kv:120"/>
                                <CheckBox x:Name="kV100CheckBox" Content="kV:100" IsChecked="False"
                                          Click="OnFilter" CommandParameter="kv:100"/>

                                <CheckBox x:Name="smallFocalCheckBox" Content="Focal:Small" IsChecked="False"
                                          Click="OnFilter" CommandParameter="Focal:Small"/>
                                <CheckBox x:Name="largeFocalCheckBox" Content="Focal:Large" IsChecked="False"
                                          Click="OnFilter" CommandParameter="Focal:Large"/>

                                <CheckBox x:Name="collimator288CheckBox" Content="Collimator:288" IsChecked="False"
                                          Click="OnFilter" CommandParameter="Collimator:288"/>
                                <CheckBox x:Name="collimator242CheckBox" Content="Collimator:242" IsChecked="False"
                                          Click="OnFilter" CommandParameter="Collimator:242"/>
                                <CheckBox x:Name="collimator144CheckBox" Content="Collimator:144" IsChecked="False"
                                          Click="OnFilter" CommandParameter="Collimator:144"/>
                            </WrapPanel>
                        </Grid>
                    </GroupBox.Header>

                    <DataGrid x:Name="argProtocolDataGrid2" 
                                  AutoGenerateColumns="False" CanUserAddRows="False"
                                  CanUserSortColumns="False"
                                  CanUserReorderColumns="False"
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Auto"
                                  IsReadOnly="True">
                        <DataGrid.Resources>
                            <DataTemplate x:Key="selectRawDataDirectoryTemplate" >
                                <Grid Grid.Row="0" VerticalAlignment="Stretch" Width="700">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="auto"/>
                                        <RowDefinition Height="auto"/>
                                    </Grid.RowDefinitions>

                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="auto" MinWidth="40"/>
                                        <ColumnDefinition Width="auto" MinWidth="40"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="RawData"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" HorizontalAlignment="Stretch"
                                             ToolTip="S03的生数据（多帧）文件夹，必须在指定目录下F:\AppData\DataMRS\ServiceData，
                                             &#13;比如F:\AppData\DataMRS\ServiceData\S03\DarkH，
                                             &#13;比如F:\AppData\DataMRS\ServiceData\Dynamic_CF_4.1ms\DarkH，
                                             &#13;最终S03的生数据（多帧）"
                                             Text="{Binding S03_RawDataPath,Mode=TwoWay,UpdateSourceTrigger=LostFocus}"/>
                                    <Button Grid.Row="1" Grid.Column="2" Name="selectS03_RawDataPathButton"
                                            Content="..." ToolTip="Select RawDataPath of S03" Width="auto" 
                                            Click="selectS03_RawDataPathButton_Click"/>
                                </Grid>
                            </DataTemplate>
                        </DataGrid.Resources>

                        <DataGrid.GroupStyle>
                            <GroupStyle>
                                <GroupStyle.ContainerStyle>
                                    <Style TargetType="{x:Type GroupItem}">
                                        <Setter Property="Margin" Value="0,0,0,5"/>
                                        <Setter Property="Template" Value="{StaticResource templateOfGroupItem}">

                                        </Setter>
                                    </Style>
                                </GroupStyle.ContainerStyle>
                            </GroupStyle>
                        </DataGrid.GroupStyle>
                        <DataGrid.Columns>
                            <DataGridTemplateColumn x:Name="RawDataDirectoryDataGridColumn" Header="RawDataDirectory"
                                                    Visibility="Collapsed" CellTemplate="{StaticResource selectRawDataDirectoryTemplate}"/>
                        </DataGrid.Columns>
                    </DataGrid>

                </GroupBox>

                <WrapPanel Grid.Row="1">
                    <TextBlock Text="{Binding ChildCheckedCount}" Margin="20,0"/>
                    <TextBlock Text="Checked"/>

                    <TextBlock Text=","/>
                    <TextBlock Text="{Binding ChildUnCheckedCount}" Margin="20,0"/>
                    <TextBlock Text="UnChecked"/>
                </WrapPanel>
            </Grid>
            <!--</ScrollViewer>-->

            <!--扫描图像-->
            <GridSplitter Grid.Row="1" Style="{StaticResource VerticalGridSplitterStyle}">
                <i:Interaction.Triggers>
                    <i:DataTrigger Binding="{Binding IsAutoConfirmResult}" Value="true">
                        <i:ChangePropertyAction PropertyName="Visibility" Value="Collapsed" />
                    </i:DataTrigger>
                </i:Interaction.Triggers>
            </GridSplitter>

            <Grid Grid.Row="2">
                <i:Interaction.Triggers>
                    <i:DataTrigger Binding="{Binding IsAutoConfirmResult}" Value="true">
                        <i:ChangePropertyAction PropertyName="Visibility" Value="Collapsed" />
                    </i:DataTrigger>
                </i:Interaction.Triggers>

                <TabControl>
                    <TabItem Header="ImageViewer" Name="imageViewTableItem">
                        <controls:ImageViewer x:Name="rawImageControl"/>
                    </TabItem>
                </TabControl>
            </Grid>

            <Grid Grid.Row="2" Width="200" VerticalAlignment="Top" HorizontalAlignment="Center">
                <i:Interaction.Triggers>
                    <i:DataTrigger Binding="{Binding IsAutoConfirmResult}" Value="true">
                        <i:ChangePropertyAction PropertyName="Visibility" Value="Collapsed" />
                    </i:DataTrigger>
                </i:Interaction.Triggers>

                <Grid.RowDefinitions>
                    <RowDefinition Height="20"></RowDefinition>
                    <RowDefinition Height="1"></RowDefinition>
                    <RowDefinition Height="20"></RowDefinition>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock HorizontalAlignment="Stretch">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{x:Static res:Calibration_Lang.Calibration_Frame_Progress}">
                                <Binding Path="ScannedProgress" />
                                <Binding Path="TotalScanCount" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Grid>

            <!--<StackPanel Orientation="Horizontal" Grid.Row="2" Width="200" VerticalAlignment="Top" HorizontalAlignment="Right">
                <Button Content="Analysis" Click="Analysis_Click" HorizontalAlignment="Left"/>
                <Button Content="Config..." Click="AnalysisConfig_Click" HorizontalAlignment="Right"/>
            </StackPanel>-->

        </Grid>
    </AdornerDecorator>
</UserControl>